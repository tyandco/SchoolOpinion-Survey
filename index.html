<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>School Opinion Survey (for research)</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main>
      <h1>What is your opinion of school?</h1>
      <p class="subtitle">A quick survey about how you feel about school. <br>(I'm doing this for research, no sensitive data will be taken from you!)</p>
      <form method="POST" action="https://formspree.io/f/mlggepjo?redirect=https%3A%2F%2Ftyandco.net%2FSchoolOpinion-Survey%2Fthanks.html">
        <label for="role">Are you a student or a teacher?</label>
        <select id="role" name="role" required>
          <option value="" selected disabled>Choose one</option>
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>

        <label for="sentiment">Thoughts of school?</label>
        <select id="sentiment" name="sentiment" required>
          <option value="" selected disabled>Choose one</option>
          <option value="never felt any better!">Never felt any better!</option>
          <option value="pretty good">Pretty good</option>
          <option value="it's alright">It's alright</option>
          <option value="ehhh..">Ehhh..</option>
          <option value="not really enjoyable..">Not really enjoyable..</option>
          <option value="downright horrible.">Downright horrible.</option>
          <option value="ass.">ASS.</option>
        </select>

        <label for="reason">Why?</label>
        <select id="reason" name="reason" required>
          <option value="" selected disabled>Choose one</option>
          <option value="school system">School system</option>
          <option value="students">Students</option>
          <option value="support">Support</option>
          <option value="other">Other (please specify)</option>
        </select>

        <div id="reasonOtherWrap" class="is-hidden">
          <label for="reasonOther">If other, please specify</label>
          <input id="reasonOther" name="reasonOther" placeholder="Optional details" />
        </div>

        <label for="talk">Want to talk about it? (optional)</label>
        <textarea id="talk" name="talk" rows="4" placeholder="Share more if you want..."></textarea>

        <button type="submit">Submit</button>
      </form>
      <script>
        const form = document.querySelector('form');
        const reasonSelect = document.getElementById('reason');
        const reasonOtherWrap = document.getElementById('reasonOtherWrap');
        const reasonOtherInput = document.getElementById('reasonOther');
        const waitingSrc = 'images/waiting.gif';
        const loggingSrc = 'images/logging.gif';
        let idleTimer;

        const submitForm = async (event) => {
          event.preventDefault();
          const action = form.getAttribute('action');
          const formData = new FormData(form);

          try {
            const response = await fetch(action, {
              method: 'POST',
              body: formData,
              headers: {
                Accept: 'application/json',
              },
            });

            if (response.ok) {
              window.location.href = 'thanks.html';
            } else {
              alert('Sorry, something went wrong. Please try again.');
            }
          } catch (error) {
            alert('Sorry, something went wrong. Please try again.');
          }
        };

        const toggleReasonOther = () => {
          const show = reasonSelect.value === 'other';
          reasonOtherWrap.classList.toggle('is-hidden', !show);
          reasonOtherInput.required = show;
          if (!show) {
            reasonOtherInput.value = '';
          }
        };

        const getStatusGif = () => document.getElementById('formStatusGif');

        const setIdle = () => {
          const statusGif = getStatusGif();
          if (!statusGif) return;
          statusGif.src = waitingSrc;
        };

        const markActive = () => {
          const statusGif = getStatusGif();
          if (!statusGif) return;
          statusGif.src = loggingSrc;
          window.clearTimeout(idleTimer);
          idleTimer = window.setTimeout(setIdle, 1500);
        };

        form.addEventListener('submit', submitForm);
        form.addEventListener('input', markActive);
        form.addEventListener('change', markActive);
        form.addEventListener('keydown', markActive);
        reasonSelect.addEventListener('change', toggleReasonOther);
        toggleReasonOther();
        setIdle();
      </script>
    </main>
    <img
      id="formStatusGif"
      class="form-gif"
      src="images/waiting.gif"
      alt="Form status animation"
    />
  </body>
</html>
